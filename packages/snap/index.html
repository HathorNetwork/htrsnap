<!doctype html>
<html>
  </head>
    <title>Hello, HTR Snaps!</title>
    <link rel="icon" type="image/svg" href="./images/icon.svg"/>
    <link rel="stylesheet" type="text/css" href="./index.css">
  </head>

  <body>
    <h1>Hello, HTR Snaps!</h1>
    <details>
      <summary>Instructions</summary>
      <ul>
        <li>First, click "Connect". Then, try out the other buttons!</li>
        <li>Please note that:</li>
        <ul>
          <li>
            The <code>snap.manifest.json</code> and <code>package.json</code> must be located in located in the server root directory..
          </li>
          <li>
            The Snap bundle must be hosted at the location specified by the <code>location</code> field of <code>snap.manifest.json</code>.
          </li>
        </ul>
      </ul>
    </details>
    <br/>

    <button class="connect">Connect</button>
    <button class="getHathorXPubKey">Get hathor Extended Public Key</button>
    <button class="getHathorAuthXPubKey">Get hathor Auth xpubkey</button>
    <button class="getHathorWalletId">Get hathor wallet id</button>
    <button class="signHathorMessage">Sign hathor message</button>
    <button class="signHathorTransaction">Sign hathor transaction</button>
    <button class="getHathorAddresses">Get hathor addresses</button>

    <div id="extendedPubKey" style="margin-top:5px"></div>
    <div id="mfp" style="margin-top:5px"></div>
    <div id="txId" style="margin-top:5px"></div>
    <div id="txHex" style="margin-top:5px"></div>
  </body>

  <script src="./wallet-lib/index.js"></script>
  <script>
    console.log(window.hathorLib);
    const snapId = `local:${window.location.href}`;
    console.log('Snapid: ', snapId);

    const connectButton = document.querySelector('button.connect')
    const getHathorXPubKeyButton = document.querySelector('button.getHathorXPubKey');
    const getHathorAuthXPubKeyButton = document.querySelector('button.getHathorAuthXPubKey');
    const getHathorWalletIdButton = document.querySelector('button.getHathorWalletId');
    const signHathorMessageButton = document.querySelector('button.signHathorMessage');
    const signHathorTransactionButton = document.querySelector('button.signHathorTransaction');
    const getHathorAddressesButton = document.querySelector('button.getHathorAddresses');

    connectButton.addEventListener('click', connect)
    getHathorXPubKeyButton.addEventListener('click', getHathorXPubKey);
    getHathorAuthXPubKeyButton.addEventListener('click', getHathorAuthXPubKey);
    getHathorWalletIdButton.addEventListener('click', getHathorWalletId);
    signHathorMessageButton.addEventListener('click', signHathorMessage);
    signHathorTransactionButton.addEventListener('click', signHathorTransaction);
    getHathorAddressesButton.addEventListener('click', getHathorAddresses);

    async function getHathorAddresses() {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: {
          snapId,
          request: {
            method: 'htr_getaddresses',
            params: {
              from: 0,
              to: 19,
            },
          }
        }
      })

      const xpubNode = document.getElementById("extendedPubKey")

      const text = response.addresses.reduce((currText, address) => {
        currText += `<li>${address}</li>`

        return currText;
      }, '<ul>') + '</ul>';

      xpubNode.innerHTML = text;
    }

    async function signHathorTransaction() {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: {
          snapId,
          request: {
            method: 'htr_signtransaction',
            params: {
              message: 'example-message-to-sign'
            },
          }
        }
      })

      console.log('response: ', response);

      const xpubNode = document.getElementById("extendedPubKey")
      xpubNode.textContent = `Signed message: ${response.signedMessage}`
    }

    async function signHathorMessage() {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: {
          snapId,
          request: {
            method: 'htr_signmessage',
            params: {
              message: 'example-message-to-sign',
              addressIndex: 1,
            },
          }
        }
      })

      console.log('response: ', response);

      const xpubNode = document.getElementById("extendedPubKey")
      xpubNode.textContent = `Signed message: ${response.signedMessage}`
    }

    async function getHathorWalletId() {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: {
          snapId,
          request: {
            method: 'htr_getwalletid',
          }
        }
      })

      const xpubNode = document.getElementById("extendedPubKey")
      xpubNode.textContent = `WalletId: ${response.walletId}`
    }

    async function getHathorXPubKey() {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: {
          snapId,
          request: {
            method: 'htr_getxpubkey',
          }
        }
      })

      const xpubNode = document.getElementById("extendedPubKey")
      xpubNode.textContent = `Xpubkey: ${response.xpub}`
    }

    async function getHathorAuthXPubKey() {
      const response = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: {
          snapId,
          request: {
            method: 'htr_getauthxpubkey',
          }
        }
      })

      const xpubNode = document.getElementById("extendedPubKey")
      xpubNode.textContent = `Auth xpubkey: ${response.xpub}`
    }

    // here we get permissions to interact with and install the snap
    async function connect () {
      await ethereum.request({
        method: 'wallet_requestSnaps',
        params: {
          [snapId]: {},
        }
      })
    }
  </script>
</html>
